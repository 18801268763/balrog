#!/usr/bin/env node

var path = require('path')
var genSiteDir = require('../lib/generate-site-dir')
var fs = require('fs')

var join = path.join.bind(path)
var currentDir = getDirectory()

var templateDir = join(currentDir, 'templates')
var partialsDir = join(currentDir, 'partials')
var inputDir = join(currentDir, 'content')
var outputDir = join(currentDir, 'site')
var optsFile = join(currentDir, 'config.json')

fs.readFile(optsFile, function (err, data) {
  if (err) console.log(err)
  var opts = resolvePaths(data)

  genSiteDir(opts, function (err, files) {
    if (err)
      throw err

    console.log('Site built')
    if (process.argv[2] === "--serve") {
      var serve = require('../lib/test-server.js')
    }
    if (process.argv[2] === "" && process.argv[2] != "--serve" ) {
      console.log("Trying to serve up your site locally? `balrog --serve` ")
    }
  })
})

function getDirectory() {
  var dirArg = process.cwd()
  return path.resolve(dirArg)
}

function resolvePaths(data) {
  var opts = JSON.parse(data)
  var needResolve = ['source', 'output', 'templateDir']

  needResolve.forEach(function (dir) {
    var thePath = opts[dir].toString()
    opts[dir] = path.resolve(thePath)
  })
  return opts
}
